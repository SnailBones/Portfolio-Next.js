# Mapbox 3D Globe

I worked as a Map Rendering Engineer at Mapbox from June 2021 through January 2023. My work focused on Mapbox GL JS, a web mapping engine used by over two million developers due to its performance and extensive customizability.

My team's largest project was **implementing 3D globe view in Mapbox GL JS**. This feature needed to enable a new 3D way of visualizing formerly 2D maps, and to provide a seamless upgrading process for existing customers, a challenging task for a complex feature touching every part of the rendering codebase. For most of 2022, I worked with [Karim Naaji](https://karim.naaji.fr/) to complete this work.

Mapbox GL JS is a profoundly complex work of software, initially built on the assumption that maps are flat. For most of its lifetime, it supported only the **[Web Mercator projection](https://en.wikipedia.org/wiki/Web_Mercator_projection)** which represents the earth as a flat square. This meant that many map features broke when depicting maps in their more realistic 3D shape. Even something as simple as **rendering a single line no longer worked**, since a 3D globe illustrates that lines on the earth are really segments of a circle. To correctly draw a line, we now had to draw the curve of an ellipse.

Almost every function related to rendering or interactivity faced similar issues. Given the scope of the engine that aspires to be the Photoshop for interactive maps, fully implementing Globe meant rewriting dozens of individual features, ensuring that they continued to work together, then solving the bugs and performance issues arising from the changes. **I implemented key features including [markers](https://github.com/mapbox/mapbox-gl-js/pull/11556), [mouse interactions](https://github.com/mapbox/mapbox-gl-js/pull/11862) and [optimized tile loading](https://github.com/mapbox/mapbox-gl-js/pull/12137).**

**I fully handled markers and popup behavior in Globe View.** In Mapbox GL JS, markers and popups are interactive CSS elements that are placed on top of the map. Correctly determining their positions and movement on a globe required **implementing TypeScript logic modeling 3D globe space** in sync with the application's WebGL rendering code. In addition to building the correct the marker behaviors for all existing options, **I designed and introduced a [new marker alignment option](https://github.com/mapbox/mapbox-gl-js/pull/11894)** placing markers perpendicular to the surface of the globe, bringing the sense of 3D to all parts of the user experience.

Tile loading proved to be a particular challenge. Mapbox's backend software breaks data into _tiles_, which are loaded and visualized by Mapbox GL JS depending on the user's camera position and zoom level. On the Web Mercator projection, these tiles are square, with each splitting into four smaller square tiles to be loaded as a user zooms in. On a globe, these tiles are no longer square, and crucially, they are no longer of uniform size. Near the poles, these tiles are smaller, so many more of them are visible. In Mapbox GL JS, the massive numbers of tiles loaded created performance issues. Choosing what tiles to load, and what zoom level to load them at, were both challenging problems that required writing complex algorithms and balancing performance with visual detail. **I implemented an algorithm calculating which tiles to load** in challenging edge cases such as a strongly tilted camera and polar regions by efficiently estimating the intersection between the pyramidal viewing frustum and the sphere. The resulting performance improvement eliminated a key bottleneck in customer adoption.

I worked closely with early-access customers to support their globe adoption by delivering prototypes, troubleshooting and optimizing their implementations, and fixing bugs that they encountered. In the final weeks before Globe launch, **I led the GL JS team in a sprint to build documentation for Globe**, including evaluating and updating our >300+ docs examples to Globe, and creating new examples like an interactive rotating globe.
