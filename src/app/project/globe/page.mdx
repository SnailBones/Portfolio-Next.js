# Mapbox 3d Globe

## Adding a Globe View to Mapbox GL

### TypeScript, WebGL

I worked as a Map Rendering Engineer at Mapbox from June 2021 through January 2023. I worked primarily on Mapbox GL JS, a web mapping engine that allows developers to build custom interactive maps, excelling in both performance and customizability.

My team's largest project was implementing 3d globe view in Mapbox GL JS, a major feature enabling a brand new customer experience and working seamlessly for existing customers, despite a complex implementation touching every part of the rendering codebase of GL JS. I worked with one other engineer for most of 2022 to complete this task, and built substantial portions of Globe, including [markers](https://github.com/mapbox/mapbox-gl-js/pull/11556), [mouse interactions](https://github.com/mapbox/mapbox-gl-js/pull/11862) and [optimized tile loading](https://github.com/mapbox/mapbox-gl-js/pull/12137).

Due to the complexity of the existing software and the assumptions built into the 2d engine, implementing globe required a mix of challenging these assumptions and working within their constraints. Even rendering a single line becomes the curve of an ellipse. For an interactive engine supporting deeply customizable styles and data, the challenges are many.

One challenge that I worked on was tile loading. Mapbox's backend software breaks data into "tiles," which are loaded and visualized by Mapbox GL JS depending on the user's camera position and zoom level. Initially, the software was built to support only the web Mercator projection. In this common map projection, the map is a square, so it is easily divided into smaller square tiles to be loaded as a user zooms in. But the Mercator map is a distortion, so applying the same tiles to a globe, we see that tiles near the poles become much smaller than those at the equator, thus many more tiles are visible at the poles, and to optimize these tiles they need to be loaded at lower zoom levels. Thus, I worked with my colleague to design and implement an algorithm to calculate the tiles to load for a particular map view, a performance-critical task.

{/* This is an efficient algorithm for 2d maps, but it rests on the assumption—baked into our front-end and back-end—of Mercator maps with a top-down, rectangular display. In a globe, the Mercator grid is no longer equally sized: tiles near the equator are larger while those near the pole are smaller. As such, we needed to simultaneously load tiles at different zoom levels. Additionally, choosing which tiles to load became a complex and performance-critical process dependent on calculation of the horizon's position. */}

I also implemented markers in 3d Globe. In addition to porting the marker behaviors and alignment from 2d, I designed and introduced a [new marker alignment option](https://github.com/mapbox/mapbox-gl-js/pull/11894) to align markers perpendicular to the surface of the globe.

Leading up to the Globe launch, I organized a sprint to develop globe documentation, including writing user guides and examples, including a demonstration for an interactive rotating globe.
